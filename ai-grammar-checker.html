<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Grammar Checker - Multietools</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/global.css">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:1.5rem;transition:background .3s,color .3s;}
.wrap{max-width:1200px;margin:0 auto;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);overflow:hidden;}
header{padding:1.75rem;border-bottom:1px solid var(--border);background:var(--primary-glow);}
h1{font-size:1.8rem;margin-bottom:.35rem;}
.muted{color:var(--muted);}
.back{display:inline-flex;align-items:center;gap:.5rem;color:var(--text);text-decoration:none;font-weight:700;margin-bottom:1rem;}
.back:hover{color:var(--primary);}
main{padding:1.5rem;display:grid;gap:1.25rem;}
.panel{background:var(--surface);border:1px solid var(--border-light);border-radius:var(--radius-md);padding:1.25rem;box-shadow:var(--shadow-xs);}

/* Score Section */
.score-bar{display:flex;align-items:center;gap:1.25rem;flex-wrap:wrap;}
.score-circle{width:72px;height:72px;position:relative;flex-shrink:0;}
.score-circle svg{transform:rotate(-90deg);}
.score-circle .track{fill:none;stroke:var(--border);stroke-width:6;}
.score-circle .fill{fill:none;stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .6s ease,stroke .4s;}
.score-value{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:900;}
.score-info{flex:1;min-width:160px;}
.score-info .score-label{font-size:.82rem;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em;}
.score-info .score-grade{font-size:1.15rem;font-weight:800;margin-top:.15rem;}
.stats-row{display:flex;flex-wrap:wrap;gap:.6rem;margin-left:auto;}
.stat-chip{background:var(--bg-alt);border:1px solid var(--border-light);border-radius:var(--radius-full);padding:.4rem .85rem;font-size:.78rem;font-weight:600;white-space:nowrap;}
.stat-chip .num{font-weight:800;color:var(--primary);}
.stat-chip.err-spelling .num{color:#ef4444;}
.stat-chip.err-grammar .num{color:#f97316;}
.stat-chip.err-punctuation .num{color:#eab308;}
.stat-chip.err-style .num{color:#3b82f6;}

/* Main Layout */
.editor-layout{display:grid;grid-template-columns:1fr 360px;gap:1.25rem;}
@media(max-width:860px){.editor-layout{grid-template-columns:1fr;}}

/* Editor Panel */
.editor-panel{display:flex;flex-direction:column;gap:.75rem;}
.editor-box{position:relative;}
.editor{min-height:320px;max-height:600px;overflow-y:auto;border:1.5px solid var(--border);border-radius:var(--radius-md);background:var(--bg-alt);color:var(--text);padding:1rem;font-size:.95rem;font-family:'Inter',system-ui,sans-serif;line-height:1.8;outline:none;transition:border-color .2s;white-space:pre-wrap;word-wrap:break-word;}
.editor:focus{border-color:var(--primary);}
.editor:empty::before{content:attr(data-placeholder);color:var(--muted);pointer-events:none;}
.editor .err-underline{border-bottom:2px solid;padding-bottom:1px;cursor:pointer;border-radius:1px;transition:background .15s;}
.editor .err-underline:hover{filter:brightness(1.2);}
.editor .err-underline.spelling{border-color:#ef4444;background:rgba(239,68,68,.1);}
.editor .err-underline.grammar{border-color:#f97316;background:rgba(249,115,22,.1);}
.editor .err-underline.punctuation{border-color:#eab308;background:rgba(234,179,8,.1);}
.editor .err-underline.style{border-color:#3b82f6;background:rgba(59,130,246,.1);}
.controls{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;}
.btn{padding:.7rem 1.2rem;border-radius:var(--radius-md);border:none;cursor:pointer;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;font-weight:700;font-size:.88rem;transition:transform .15s,box-shadow .25s;display:inline-flex;align-items:center;gap:.4rem;}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(124,58,237,.3);}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.btn-outline{background:var(--surface);color:var(--primary);border:1.5px solid var(--primary);}
.btn-outline:hover{background:var(--primary-glow);transform:translateY(-1px);}
.btn-success{background:linear-gradient(135deg,var(--success),#34d399);}
.btn-success:hover{box-shadow:0 4px 16px rgba(16,185,129,.3);}
.btn-sm{padding:.5rem .85rem;font-size:.8rem;}
.word-info{color:var(--muted);font-size:.82rem;margin-left:auto;display:flex;gap:1rem;}

/* Issues Panel */
.issues-panel{display:flex;flex-direction:column;gap:.75rem;max-height:calc(320px + 3rem + 40px + 1.5rem);overflow:hidden;}
.issues-header{display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.issues-header h3{font-size:1rem;display:flex;align-items:center;gap:.4rem;}
.issues-count{background:var(--error);color:#fff;font-size:.7rem;font-weight:700;padding:.15rem .5rem;border-radius:var(--radius-full);min-width:22px;text-align:center;}
.issues-filter{display:flex;gap:.35rem;flex-wrap:wrap;flex-shrink:0;}
.filter-btn{padding:.3rem .65rem;border-radius:var(--radius-full);border:1px solid var(--border);background:var(--bg-alt);color:var(--muted);font-size:.72rem;font-weight:600;cursor:pointer;transition:all .15s;}
.filter-btn.active,.filter-btn:hover{background:var(--primary-glow);border-color:var(--primary);color:var(--primary);}
.issues-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:.5rem;padding-right:.25rem;}
.issues-list::-webkit-scrollbar{width:5px;}
.issues-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.issue-card{background:var(--bg-alt);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:.75rem;cursor:pointer;transition:all .15s;position:relative;border-left:3px solid transparent;}
.issue-card:hover{border-color:var(--primary);box-shadow:var(--shadow-sm);}
.issue-card.spelling{border-left-color:#ef4444;}
.issue-card.grammar{border-left-color:#f97316;}
.issue-card.punctuation{border-left-color:#eab308;}
.issue-card.style{border-left-color:#3b82f6;}
.issue-top{display:flex;align-items:center;gap:.5rem;margin-bottom:.35rem;}
.issue-badge{font-size:.65rem;font-weight:700;text-transform:uppercase;padding:.15rem .5rem;border-radius:var(--radius-full);letter-spacing:.03em;}
.issue-badge.spelling{background:rgba(239,68,68,.12);color:#ef4444;}
.issue-badge.grammar{background:rgba(249,115,22,.12);color:#f97316;}
.issue-badge.punctuation{background:rgba(234,179,8,.12);color:#b45309;}
.issue-badge.style{background:rgba(59,130,246,.12);color:#3b82f6;}
.issue-original{font-size:.85rem;text-decoration:line-through;color:var(--error);font-weight:600;}
.issue-arrow{color:var(--muted);font-size:.75rem;}
.issue-suggestion{font-size:.85rem;color:var(--success);font-weight:700;}
.issue-explain{font-size:.78rem;color:var(--muted);line-height:1.4;margin-top:.25rem;}
.issue-fix-btn{position:absolute;top:.65rem;right:.65rem;background:var(--success);color:#fff;border:none;border-radius:var(--radius-full);width:24px;height:24px;font-size:.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s,transform .15s;}
.issue-card:hover .issue-fix-btn{opacity:1;}
.issue-fix-btn:hover{transform:scale(1.15);}
.no-issues{text-align:center;color:var(--muted);padding:2rem 1rem;font-size:.9rem;}
.no-issues i{font-size:2rem;color:var(--success);display:block;margin-bottom:.5rem;}

/* Loading */
.loading{display:none;align-items:center;justify-content:center;gap:.75rem;padding:2rem;font-weight:600;color:var(--muted);}
.loading.active{display:flex;}
.spinner{width:22px;height:22px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* Toast */
.toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(20px);padding:.75rem 1.5rem;border-radius:50px;background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow-lg);font-weight:600;font-size:.9rem;z-index:9999;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Info box */
.info-box{background:var(--bg-alt);border-left:3px solid var(--primary);border-radius:var(--radius-sm);padding:.75rem 1rem;font-size:.82rem;color:var(--muted);line-height:1.5;}

@media(max-width:640px){
	.controls{flex-direction:column;align-items:stretch;}
	.word-info{margin-left:0;justify-content:center;}
	.score-bar{flex-direction:column;align-items:flex-start;}
	.stats-row{margin-left:0;}
	body{padding:.75rem;}
}
</style>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
</head>
<body>
<div class="wrap">
	<header>
		<a class="back" href="tools.html#ai-tools"><i class="fas fa-arrow-left"></i> Back to Tools</a>
		<h1><i class="fas fa-spell-check"></i> AI Grammar Checker</h1>
		<p class="muted">Check grammar, spelling, punctuation, and style — get instant suggestions to improve your writing.</p>
	</header>
	<main>
		<!-- Score Panel -->
		<div class="panel" id="scorePanel" style="display:none;">
			<div class="score-bar">
				<div class="score-circle">
					<svg viewBox="0 0 72 72" width="72" height="72">
						<circle class="track" cx="36" cy="36" r="30"/>
						<circle class="fill" id="scoreFill" cx="36" cy="36" r="30"
							stroke-dasharray="188.5" stroke-dashoffset="188.5"/>
					</svg>
					<div class="score-value" id="scoreValue">—</div>
				</div>
				<div class="score-info">
					<div class="score-label">Writing Score</div>
					<div class="score-grade" id="scoreGrade">Enter text to check</div>
				</div>
				<div class="stats-row" id="statsRow">
					<span class="stat-chip">Total: <span class="num" id="statTotal">0</span></span>
					<span class="stat-chip err-spelling">Spelling: <span class="num" id="statSpelling">0</span></span>
					<span class="stat-chip err-grammar">Grammar: <span class="num" id="statGrammar">0</span></span>
					<span class="stat-chip err-punctuation">Punctuation: <span class="num" id="statPunctuation">0</span></span>
					<span class="stat-chip err-style">Style: <span class="num" id="statStyle">0</span></span>
				</div>
			</div>
		</div>

		<!-- Main Editor + Issues -->
		<div class="editor-layout">
			<!-- Left: Editor -->
			<div class="editor-panel">
				<div class="panel" style="padding:0;overflow:hidden;">
					<div class="editor-box">
						<div class="editor" id="editor" contenteditable="true" spellcheck="false"
							data-placeholder="Type or paste your text here to check grammar, spelling, punctuation and style..."></div>
					</div>
				</div>
				<div class="controls">
					<button class="btn" id="checkBtn" onclick="runCheck()"><i class="fas fa-search"></i> Check Grammar</button>
					<button class="btn btn-success" id="fixAllBtn" onclick="fixAll()" style="display:none;"><i class="fas fa-magic"></i> Fix All</button>
					<button class="btn btn-outline" onclick="copyText()"><i class="fas fa-copy"></i> Copy Text</button>
					<button class="btn btn-outline" onclick="clearAll()"><i class="fas fa-eraser"></i> Clear</button>
					<div class="word-info">
						<span id="wordCount">0 words</span>
						<span id="sentenceCount">0 sentences</span>
					</div>
				</div>
				<div class="loading" id="loading"><div class="spinner"></div> Analyzing your text...</div>
				<div class="info-box">
					<i class="fas fa-info-circle"></i> This grammar checker uses a built-in rule engine with 100+ spelling corrections, grammar pattern matching, punctuation rules, and style suggestions. All processing is done locally in your browser — no data is sent anywhere.
				</div>
			</div>

			<!-- Right: Issues -->
			<div class="panel issues-panel" id="issuesPanel">
				<div class="issues-header">
					<h3><i class="fas fa-exclamation-triangle"></i> Issues <span class="issues-count" id="issuesCount">0</span></h3>
				</div>
				<div class="issues-filter">
					<button class="filter-btn active" data-filter="all" onclick="filterIssues('all',this)">All</button>
					<button class="filter-btn" data-filter="spelling" onclick="filterIssues('spelling',this)"> Spelling</button>
					<button class="filter-btn" data-filter="grammar" onclick="filterIssues('grammar',this)"> Grammar</button>
					<button class="filter-btn" data-filter="punctuation" onclick="filterIssues('punctuation',this)"> Punctuation</button>
					<button class="filter-btn" data-filter="style" onclick="filterIssues('style',this)"> Style</button>
				</div>
				<div class="issues-list" id="issuesList">
					<div class="no-issues"><i class="fas fa-check-circle"></i>No issues found yet.<br>Click "Check Grammar" to analyze your text.</div>
				</div>
			</div>
		</div>
	</main>
</div>

<div class="toast" id="toast"></div>

<script src="js/global.js"></script>
<script>
/* ==============================================================
   AI Grammar Checker — Client-Side Rule Engine
   ============================================================== */

// ─── State ────────────────────────────────────────────────────
let currentIssues = [];
let activeFilter = 'all';

// ─── DOM refs ─────────────────────────────────────────────────
const editorEl      = document.getElementById('editor');
const wordCountEl   = document.getElementById('wordCount');
const sentCountEl   = document.getElementById('sentenceCount');
const issuesListEl  = document.getElementById('issuesList');
const issuesCountEl = document.getElementById('issuesCount');
const scorePanelEl  = document.getElementById('scorePanel');
const scoreValueEl  = document.getElementById('scoreValue');
const scoreGradeEl  = document.getElementById('scoreGrade');
const scoreFillEl   = document.getElementById('scoreFill');
const loadingEl     = document.getElementById('loading');
const fixAllBtn     = document.getElementById('fixAllBtn');
const checkBtn      = document.getElementById('checkBtn');

// ─── Helpers ──────────────────────────────────────────────────
function getPlainText(){
	return editorEl.innerText || '';
}
function getWords(text){
	return text.trim().split(/\s+/).filter(w=>w.length>0);
}
function getSentences(text){
	return text.split(/(?<=[.!?])\s+/).filter(s=>s.trim().length>0);
}

editorEl.addEventListener('input',()=>{
	const text=getPlainText();
	const words=getWords(text);
	const sentences=getSentences(text);
	wordCountEl.textContent=words.length+' word'+(words.length!==1?'s':'');
	sentCountEl.textContent=sentences.length+' sentence'+(sentences.length!==1?'s':'');
});

// ─── Toast ────────────────────────────────────────────────────
function showToast(msg){
	const t=document.getElementById('toast');
	t.textContent=msg;t.classList.add('show');
	setTimeout(()=>t.classList.remove('show'),2400);
}

// ─── SPELLING DICTIONARY (100+ entries) ───────────────────────
const MISSPELLINGS = {
	'teh':'the','thier':'their','recieve':'receive','beleive':'believe','occured':'occurred',
	'seperate':'separate','definately':'definitely','goverment':'government','occassion':'occasion',
	'neccessary':'necessary','accomodate':'accommodate','maintainance':'maintenance',
	'independant':'independent','occurence':'occurrence','wierd':'weird','calender':'calendar',
	'committment':'commitment','embarass':'embarrass','enviroment':'environment',
	'flourescent':'fluorescent','foriegn':'foreign','grammer':'grammar','harrass':'harass',
	'immediatly':'immediately','jewelery':'jewelry','knowlege':'knowledge','liason':'liaison',
	'manouvre':'manoeuvre','millenium':'millennium','miniscule':'minuscule','mischievious':'mischievous',
	'noticable':'noticeable','persistant':'persistent','pharoah':'pharaoh','playwrite':'playwright',
	'posession':'possession','preceed':'precede','privelige':'privilege','pronounciation':'pronunciation',
	'publically':'publicly','que':'queue','questionaire':'questionnaire','realy':'really',
	'refered':'referred','relevent':'relevant','religous':'religious','rember':'remember',
	'resistence':'resistance','seige':'siege','sentance':'sentence','sergant':'sergeant',
	'succesful':'successful','supercede':'supersede','surprize':'surprise','tommorow':'tomorrow',
	'tounge':'tongue','truely':'truly','tyrany':'tyranny','untill':'until','vaccuum':'vacuum',
	'vegatarian':'vegetarian','wether':'whether','writting':'writing','wich':'which',
	'becuase':'because','beacuse':'because','restaraunt':'restaurant','amature':'amateur',
	'appearence':'appearance','arguement':'argument','basicly':'basically','beutiful':'beautiful',
	'begining':'beginning','buisness':'business','catagory':'category','changable':'changeable',
	'colledge':'college','comming':'coming','concious':'conscious','curiousity':'curiosity',
	'decieve':'deceive','desparate':'desperate','diffrence':'difference','disapear':'disappear',
	'disapoint':'disappoint','dosen':'doesn','ecstacy':'ecstasy','efficency':'efficiency',
	'eigth':'eighth','exagerate':'exaggerate','excelent':'excellent','existance':'existence',
	'explaination':'explanation','familar':'familiar','finaly':'finally','fourty':'forty',
	'freind':'friend','gaurd':'guard','glamourous':'glamorous','goverment':'government',
	'gratefull':'grateful','guarentee':'guarantee','happyness':'happiness','heighth':'height',
	'humourous':'humorous','ignorence':'ignorance','imaginery':'imaginary','interupt':'interrupt',
	'iresistible':'irresistible','itenary':'itinerary','jeopardise':'jeopardize',
	'judgement':'judgment','kernal':'kernel','labelled':'labeled','liesure':'leisure',
	'lenght':'length','libary':'library','liscense':'license','maintainence':'maintenance',
	'manuever':'maneuver','medeval':'medieval','memento':'memento','momento':'memento',
	'misspel':'misspell','naturaly':'naturally','neice':'niece','nineth':'ninth',
	'ocasionally':'occasionally','offical':'official','opertunity':'opportunity',
	'optimisim':'optimism','outragous':'outrageous','parliment':'parliament',
	'particulary':'particularly','passtime':'pastime','percieve':'perceive',
	'performence':'performance','perseverence':'perseverance','personel':'personnel',
	'plagarism':'plagiarism','politican':'politician','portugese':'portuguese',
	'prefered':'preferred','probaly':'probably','professer':'professor',
	'programing':'programming','prominant':'prominent','psycology':'psychology',
	'recomend':'recommend','refrence':'reference','rythm':'rhythm','shedule':'schedule',
	'sissors':'scissors','sence':'sense','similer':'similar','sincearly':'sincerely',
	'speach':'speech','strenght':'strength','stuborn':'stubborn','successfull':'successful',
	'supposidly':'supposedly','temperture':'temperature','tendancy':'tendency',
	'therefor':'therefore','threshhold':'threshold','tomatos':'tomatoes','tradgedy':'tragedy',
	'transfered':'transferred','unavoidible':'unavoidable','underate':'underrate',
	'unfortunatly':'unfortunately','unnecesary':'unnecessary','useable':'usable',
	'usefull':'useful','valueable':'valuable','visious':'vicious','wensday':'wednesday',
	'whereever':'wherever','tho':'though','ur':'your','alot':'a lot','abit':'a bit',
	'aswell':'as well','eachother':'each other','infact':'in fact','alright':'all right',
	'noone':'no one','awhile':'a while','nite':'night','lite':'light','thru':'through',
	'reccomend':'recommend','acommodate':'accommodate','agressive':'aggressive',
	'apparantly':'apparently','acheive':'achieve','aquire':'acquire','athiest':'atheist',
	'awfull':'awful','bizzare':'bizarre','bouy':'buoy','carribean':'Caribbean',
	'camoflage':'camouflage','cemetary':'cemetery','chauffer':'chauffeur','colum':'column',
	'concensus':'consensus','copywrite':'copyright','corosion':'corrosion',
	'daiquiri':'daiquiri','diarrea':'diarrhea','dilema':'dilemma',
	'disipline':'discipline','drunkeness':'drunkenness','dumbell':'dumbbell',
	'excede':'exceed','facinate':'fascinate','firey':'fiery','garantee':'guarantee',
	'genious':'genius','geneology':'genealogy','gorilla':'guerrilla',
	'hemorage':'hemorrhage','hygeine':'hygiene','idiosyncracy':'idiosyncrasy',
	'incidently':'incidentally','innoculate':'inoculate','intelligance':'intelligence'
};

// ─── GRAMMAR RULES (regex-based) ─────────────────────────────
const GRAMMAR_RULES = [
	// Double words
	{regex:/\b(\w+)\s+\1\b/gi, type:'grammar', msg:'Duplicate word detected.', fix:(m,w)=>w,
		explain:'The same word appears twice in a row.'},
	// a/an before vowel sound
	{regex:/\ba\s+([aeiou]\w*)\b/gi, type:'grammar',
		msg:m=>`Use "an" before "${m[1]}".`, fix:(m)=>'an '+m[1],
		explain:'Use "an" before words that start with a vowel sound.'},
	// an before consonant sound
	{regex:/\ban\s+([bcdfghjklmnpqrstvwxyz]\w*)\b/gi, type:'grammar',
		msg:m=>`Use "a" before "${m[1]}".`, fix:(m)=>'a '+m[1],
		explain:'Use "a" before words that start with a consonant sound.',
		exceptions:['hour','honest','honor','heir','herb','homage']},
	// I lowercase
	{regex:/(?<=[.!?]\s)\bi\b(?=\s)/g, type:'grammar',
		msg:'Capitalize "I".', fix:()=>'I',
		explain:'The pronoun "I" should always be capitalized.'},
	{regex:/^\bi\b(?=\s)/gm, type:'grammar',
		msg:'Capitalize "I".', fix:()=>'I',
		explain:'The pronoun "I" should always be capitalized.'},
	// its vs it's (common confusion — flag "its" before a verb)
	{regex:/\bits\s+(is|was|has|had|been|going|not|a\s+very)\b/gi, type:'grammar',
		msg:'Did you mean "it\'s" (it is)?', fix:(m)=>"it's "+m[1],
		explain:'"It\'s" is a contraction of "it is" or "it has". "Its" is possessive.'},
	// your vs you're before adjective/verb
	{regex:/\byour\s+(welcome|right|wrong|the\s+best|going|doing|being|making|looking|getting)\b/gi, type:'grammar',
		msg:'Did you mean "you\'re" (you are)?', fix:(m)=>"you're "+m[1],
		explain:'"You\'re" is a contraction of "you are". "Your" is possessive.'},
	// there/their/they're
	{regex:/\bthere\s+(car|house|dog|cat|book|idea|problem|team|children|parents|going|doing)\b/gi, type:'grammar',
		msg:'Did you mean "their"?', fix:(m)=>'their '+m[1],
		explain:'"Their" is possessive. "There" refers to a place.'},
	// then vs than in comparisons
	{regex:/\b(more|better|worse|greater|less|faster|slower|bigger|smaller|taller|shorter|higher|lower|rather)\s+then\b/gi, type:'grammar',
		msg:'Use "than" for comparisons.', fix:(m)=>m[1]+' than',
		explain:'"Than" is used for comparisons; "then" refers to time.'},
	// subject-verb agreement: "he don't", "she don't"
	{regex:/\b(he|she|it)\s+don't\b/gi, type:'grammar',
		msg:m=>`Use "doesn't" with "${m[1]}".`, fix:(m)=>m[1]+" doesn't",
		explain:'Third-person singular subjects require "doesn\'t" instead of "don\'t".'},
	// "could of" → "could have"
	{regex:/\b(could|would|should|might|must)\s+of\b/gi, type:'grammar',
		msg:m=>`Use "${m[1]} have" instead of "${m[1]} of".`, fix:(m)=>m[1]+' have',
		explain:'The correct form is "could have", not "could of". The confusion comes from the contraction "could\'ve".'},
	// "less" with countable nouns
	{regex:/\bless\s+(people|items|things|books|cars|dollars|hours|minutes|days|years|students|employees|problems|questions|options)\b/gi, type:'grammar',
		msg:m=>`Use "fewer" with countable noun "${m[1]}".`, fix:(m)=>'fewer '+m[1],
		explain:'"Fewer" is used with countable nouns; "less" is for uncountable quantities.'},
	// "who" vs "whom" — simplified
	{regex:/\bwho\s+(did\s+\w+\s+\w+|was\s+it\s+given|do\s+you\s+see|should\s+I\s+call|are\s+you\s+talking)\b/gi, type:'grammar',
		msg:'Consider using "whom".', fix:(m)=>'whom '+m[1],
		explain:'"Whom" is used as the object of a verb or preposition.'},
	// affect vs effect
	{regex:/\bthe\s+affect\b/gi, type:'grammar',
		msg:'Did you mean "effect" (noun)?', fix:()=>'the effect',
		explain:'As a noun, use "effect". "Affect" is typically a verb.'},
	// "me and" at start of sentence / subject position
	{regex:/(?:^|(?<=[.!?]\s))me\s+and\s+(\w+)\b/gim, type:'grammar',
		msg:m=>`Use "${m[1]} and I" as the subject.`, fix:(m)=>m[1]+' and I',
		explain:'When used as a subject, say "X and I", not "me and X".'},
	// "alot" is handled in spelling, but "allot" vs "a lot"
	{regex:/\b(is|are|was|were)\s+a\s+lots?\s+of\b/gi, type:'grammar',
		msg:'Use "a lot" (two words).', fix:(m)=>m[1]+' a lot of',
		explain:'"A lot" is always two words.'},
	// "suppose to" → "supposed to"
	{regex:/\b(suppose|use)\s+to\b/gi, type:'grammar',
		msg:m=>`Use "${m[1]}d to".`, fix:(m)=>m[1]+'d to',
		explain:`The correct forms are "supposed to" and "used to" with the past tense.`},
	// double negatives
	{regex:/\b(don't|doesn't|didn't|won't|wouldn't|can't|couldn't|isn't|aren't|wasn't|weren't)\s+(no|nothing|neither|nobody|nowhere|never)\b/gi, type:'grammar',
		msg:'Avoid double negatives.', fix:null,
		explain:'Using two negatives in a clause can create confusion or unintended meaning.'},
	// "between you and I" → "between you and me"
	{regex:/\bbetween\s+(you|her|him|them)\s+and\s+I\b/gi, type:'grammar',
		msg:'Use "me" after "between".', fix:(m)=>'between '+m[1]+' and me',
		explain:'After prepositions like "between", use the objective case "me", not "I".'},
	// "irregardless"
	{regex:/\birregardless\b/gi, type:'grammar',
		msg:'Use "regardless" instead.', fix:()=>'regardless',
		explain:'"Irregardless" is nonstandard. Use "regardless".'},
	// "literally" misuse (mild flag)
	{regex:/\bliterally\s+(died|exploded|killed|destroyed|on\s+fire)\b/gi, type:'grammar',
		msg:'Possible misuse of "literally".', fix:null,
		explain:'"Literally" means in a literal sense. Consider whether you mean "figuratively".'}
];

// ─── PUNCTUATION RULES ───────────────────────────────────────
const PUNCTUATION_RULES = [
	// Double spaces
	{regex:/[^\n] {2,}/g, type:'punctuation',
		msg:'Multiple spaces detected.', fix:(m)=>m[0].replace(/ {2,}/g,' '),
		explain:'Use a single space between words.'},
	// Missing space after period/comma/colon/semicolon
	{regex:/[.!?,;:](?=[A-Za-z])/g, type:'punctuation',
		msg:m=>`Add a space after "${m[0][0]}".`, fix:(m)=>m[0][0]+' '+m[0].slice(1),
		explain:'Punctuation marks should be followed by a space.'},
	// Space before punctuation
	{regex:/\s+[,;:!?]/g, type:'punctuation',
		msg:'Remove space before punctuation.', fix:(m)=>m[0].trim(),
		explain:'There should be no space before commas, semicolons, colons, or other punctuation.'},
	// Missing capitalization after period
	{regex:/[.!?]\s+[a-z]/g, type:'punctuation',
		msg:'Capitalize the first word after a sentence-ending period.', fix:(m)=>m[0].slice(0,-1)+m[0].slice(-1).toUpperCase(),
		explain:'The first letter after a sentence-ending punctuation mark should be capitalized.'},
	// Sentence not ending with punctuation (at end of text)
	{regex:/[a-zA-Z]\s*$/g, type:'punctuation',
		msg:'Sentence may be missing ending punctuation.',fix:null,
		explain:'Sentences should end with a period, question mark, or exclamation mark.'},
	// Multiple exclamation/question marks
	{regex:/[!]{2,}/g, type:'punctuation',
		msg:'Avoid multiple exclamation marks.',fix:(m)=>'!',
		explain:'In formal writing, use a single exclamation mark.'},
	{regex:/[?]{2,}/g, type:'punctuation',
		msg:'Avoid multiple question marks.', fix:(m)=>'?',
		explain:'In formal writing, use a single question mark.'},
	// Missing comma before conjunctions in compound sentences (simplified)
	{regex:/\b\w{3,}\s+(and|but|or|yet|so)\s+\w+/gi, type:'punctuation',
		msg:null, fix:null, skip:true}, // placeholder for complex rule below
	// Comma splice detection
	{regex:/,\s*(however|therefore|moreover|furthermore|otherwise|consequently|nevertheless)\b/gi, type:'punctuation',
		msg:m=>`Use a semicolon before "${m[1]}" or start a new sentence.`,
		fix:(m)=>'; '+m[1],
		explain:'Conjunctive adverbs like "however" need a semicolon or period, not just a comma.'},
	// Missing Oxford comma hint (optional)
	{regex:/\b\w+,\s+\w+\s+and\s+\w+\b/gi, type:'punctuation',
		msg:null, fix:null, skip:true}, // too noisy, skip
	// Misplaced apostrophe in decades
	{regex:/\b(\d{4})'s\b/g, type:'punctuation',
		msg:'Use "s" without apostrophe for decade plurals.', fix:(m)=>m[1]+'s',
		explain:'Decades as plurals don\'t need an apostrophe (e.g., "1990s" not "1990\'s").'},
	// Ellipsis with wrong number of dots
	{regex:/\.{2}(?!\.)/g, type:'punctuation',
		msg:'Use three dots for an ellipsis (…).', fix:()=>'...',
		explain:'An ellipsis consists of three dots.'},
	{regex:/\.{4,}/g, type:'punctuation',
		msg:'An ellipsis should have exactly three dots.', fix:()=>'...',
		explain:'Use exactly three dots for an ellipsis.'},
	// Starting sentence with lowercase
	{regex:/(?:^|\n)\s*[a-z]/gm, type:'punctuation',
		msg:'Capitalize the first word of a sentence.',
		fix:(m)=>m[0].slice(0,-1)+m[0].slice(-1).toUpperCase(),
		explain:'Sentences should start with a capital letter.'},
	// Quotation marks — straight to curly hint
	{regex:/\s"(\w)/g, type:'punctuation',
		msg:null, fix:null, skip:true},
	// Missing comma after introductory words
	{regex:/(?:^|(?<=[.!?]\s))(However|Moreover|Furthermore|Therefore|Nevertheless|Meanwhile|Consequently|Additionally|Similarly|Likewise|Indeed|Certainly|Clearly|Obviously|Apparently|Unfortunately|Fortunately|Interestingly|Surprisingly|Importantly)\s+(?!,)/gim, type:'punctuation',
		msg:m=>`Add a comma after "${m[1]}".`,
		fix:(m)=>m[1]+', '+m[0].slice(m[1].length).trimStart(),
		explain:'Introductory words and transitional phrases are typically followed by a comma.'}
];

// ─── STYLE SUGGESTIONS ───────────────────────────────────────
const STYLE_RULES = [
	// Passive voice patterns
	{regex:/\b(is|are|was|were|been|being|be)\s+(being\s+)?(acknowledged|adapted|adjusted|administered|affected|agreed|amazed|amused|annoyed|approved|arranged|assumed|attacked|attempted|awarded|based|beaten|believed|born|broken|built|burned|called|caught|caused|changed|chosen|claimed|closed|collected|committed|compared|completed|composed|concerned|confirmed|connected|considered|constructed|contained|controlled|convinced|covered|created|damaged|decided|defined|delivered|demanded|denied|described|designed|destroyed|determined|developed|directed|discovered|discussed|distributed|done|drawn|dressed|driven|dropped|eaten|effected|employed|encouraged|enjoyed|established|examined|excited|expected|experienced|explained|expressed|extended|faced|fed|felt|filled|focused|followed|forced|formed|found|frightened|given|gone|grown|guided|handled|heard|held|helped|hidden|hit|identified|ignored|illustrated|imagined|improved|included|increased|indicated|influenced|informed|inspired|intended|interested|introduced|invested|invited|involved|joined|judged|kept|killed|known|laid|led|left|limited|linked|loaded|lost|loved|made|maintained|managed|marked|meant|measured|mentioned|met|missed|motivated|moved|needed|noted|observed|obtained|offered|opened|operated|organized|overcome|owned|paid|passed|perceived|performed|permitted|persuaded|placed|planned|played|pleased|pointed|prepared|presented|preserved|prevented|produced|promised|proposed|protected|proved|provided|published|pulled|pushed|put|raised|reached|read|realized|received|recognized|recommended|recorded|reduced|referred|reflected|regarded|related|released|remained|remembered|removed|replaced|reported|represented|requested|required|respected|revealed|reviewed|rid|ruled|said|satisfied|saved|seen|selected|sent|separated|served|set|settled|shared|shot|shown|shut|signed|situated|sold|sorted|sought|spent|spoken|spread|started|stated|stolen|stopped|stretched|struck|studied|suggested|supported|supposed|surrounded|taken|talked|taught|tested|thought|thrown|told|touched|trained|transferred|treated|tried|troubled|trusted|turned|understood|united|used|valued|visited|wanted|warned|washed|watched|weakened|welcomed|widened|wished|won|worked|worried|worn|written|wronged)\b/gi,
		type:'style', msg:'Passive voice detected. Consider active voice.',fix:null,
		explain:'Active voice is generally more direct and engaging than passive voice.'},
	// Wordy phrases
	{regex:/\bin order to\b/gi, type:'style', msg:'Simplify: "in order to" → "to".', fix:()=>'to',
		explain:'"In order to" can usually be shortened to "to".'},
	{regex:/\bdue to the fact that\b/gi, type:'style', msg:'Simplify: "due to the fact that" → "because".', fix:()=>'because',
		explain:'Replace wordy phrase with "because".'},
	{regex:/\bat this point in time\b/gi, type:'style', msg:'Simplify: "at this point in time" → "now".', fix:()=>'now',
		explain:'Replace wordy phrase with "now".'},
	{regex:/\bin the event that\b/gi, type:'style', msg:'Simplify: "in the event that" → "if".', fix:()=>'if',
		explain:'Replace wordy phrase with "if".'},
	{regex:/\bfor the purpose of\b/gi, type:'style', msg:'Simplify: "for the purpose of" → "to" or "for".', fix:()=>'for',
		explain:'Replace wordy phrase with something shorter.'},
	{regex:/\bwith regard to\b/gi, type:'style', msg:'Simplify: "with regard to" → "about" or "regarding".', fix:()=>'regarding',
		explain:'Replace wordy phrase with a concise alternative.'},
	{regex:/\bin spite of the fact that\b/gi, type:'style', msg:'Simplify: "in spite of the fact that" → "although".', fix:()=>'although',
		explain:'Replace wordy phrase with "although".'},
	{regex:/\bat the present time\b/gi, type:'style', msg:'Simplify: "at the present time" → "now" or "currently".', fix:()=>'currently',
		explain:'Replace wordy phrase with "currently" or "now".'},
	{regex:/\bhas the ability to\b/gi, type:'style', msg:'Simplify: "has the ability to" → "can".', fix:()=>'can',
		explain:'"Can" is more concise.'},
	{regex:/\bon a daily basis\b/gi, type:'style', msg:'Simplify: "on a daily basis" → "daily".', fix:()=>'daily',
		explain:'Replace wordy phrase with "daily".'},
	{regex:/\bbasically\b/gi, type:'style', msg:'Consider removing filler word "basically".', fix:null,
		explain:'"Basically" is often an unnecessary filler word.'},
	{regex:/\bvery\s+(unique|perfect|complete|dead|empty|equal|eternal|fatal|final|impossible|infinite|pregnant|supreme|total|unanimous|universal)\b/gi,
		type:'style', msg:m=>`"${m[1]}" is absolute — "very" is redundant.`, fix:(m)=>m[1],
		explain:'Absolute adjectives cannot be modified by "very".'},
	// Clichés
	{regex:/\bat the end of the day\b/gi, type:'style', msg:'Cliché: "at the end of the day". Consider rephrasing.', fix:null,
		explain:'Clichés can weaken your writing. Try a more original expression.'},
	{regex:/\bthink outside the box\b/gi, type:'style', msg:'Cliché: "think outside the box". Consider rephrasing.', fix:null,
		explain:'Clichés can weaken your writing.'},
	{regex:/\bapples and oranges\b/gi, type:'style', msg:'Cliché: "apples and oranges". Consider rephrasing.',fix:null,
		explain:'Clichés can weaken your writing.'},
	{regex:/\bit goes without saying\b/gi, type:'style', msg:'Cliché: "it goes without saying". If so, don\'t say it.', fix:null,
		explain:'If something goes without saying, you might not need to include it.'},
	{regex:/\blast but not least\b/gi, type:'style', msg:'Cliché: "last but not least". Consider rephrasing.', fix:null,
		explain:'Clichés can weaken your writing.'},
	{regex:/\bneedle in a haystack\b/gi, type:'style', msg:'Cliché: "needle in a haystack".', fix:null,
		explain:'Clichés can weaken your writing.'},
	{regex:/\bonly time will tell\b/gi, type:'style', msg:'Cliché: "only time will tell".', fix:null,
		explain:'Clichés can weaken your writing.'},
	{regex:/\bplaying with fire\b/gi, type:'style', msg:'Cliché: "playing with fire".', fix:null,
		explain:'Clichés can weaken your writing.'},
	{regex:/\bin this day and age\b/gi, type:'style', msg:'Cliché: "in this day and age" → try "today" or "currently".', fix:()=>'today',
		explain:'Replace cliché with a concise alternative.'},
	{regex:/\beach and every\b/gi, type:'style', msg:'Wordy: "each and every" → use "each" or "every".', fix:()=>'every',
		explain:'"Each and every" is redundant. Use one or the other.'},
	{regex:/\bfirst and foremost\b/gi, type:'style', msg:'Wordy: "first and foremost" → use "first".', fix:()=>'first',
		explain:'"First and foremost" is redundant.'},
	{regex:/\b(very|really|extremely|quite|rather|somewhat|fairly)\s+(good|bad|big|small|nice|great|important|interesting)\b/gi,
		type:'style', msg:m=>`Consider a stronger word instead of "${m[1]} ${m[2]}".`, fix:null,
		explain:'Using a more precise adjective is more impactful than an adverb + weak adjective.'}
];


// ─── MAIN CHECK FUNCTION ─────────────────────────────────────
async function runCheck() {
	const text = getPlainText().trim();
	if(!text || getWords(text).length < 3){
		showToast('Please enter some text to check.');
		return;
	}

	checkBtn.disabled = true;
	loadingEl.classList.add('active');
	fixAllBtn.style.display = 'none';
	scorePanelEl.style.display = 'none';

	// Small delay for UX
	await new Promise(r => setTimeout(r, 400 + Math.random()*400));

	currentIssues = [];

	// — Run spelling check —
	checkSpelling(text);

	// — Run grammar rules —
	runRuleSet(GRAMMAR_RULES, text);

	// — Run punctuation rules —
	runRuleSet(PUNCTUATION_RULES, text);

	// — Run style rules —
	runRuleSet(STYLE_RULES, text);

	// Remove duplicates (same position)
	deduplicateIssues();

	// Sort by position
	currentIssues.sort((a,b)=>a.index - b.index);

	// Update UI
	updateScore(text);
	renderIssues();
	highlightErrors(text);

	loadingEl.classList.remove('active');
	scorePanelEl.style.display = '';
	if(currentIssues.length > 0) fixAllBtn.style.display = '';
	checkBtn.disabled = false;

	showToast(currentIssues.length === 0 ? 'No issues found!' : currentIssues.length + ' issue'+(currentIssues.length!==1?'s':'')+' found');
}

function checkSpelling(text) {
	const wordRegex = /\b[a-zA-Z']+\b/g;
	let match;
	while((match = wordRegex.exec(text)) !== null) {
		const word = match[0];
		const lower = word.toLowerCase();
		if(MISSPELLINGS[lower]) {
			const suggestion = MISSPELLINGS[lower];
			// Preserve original capitalization pattern
			let fixedWord = suggestion;
			if(word[0] === word[0].toUpperCase()) {
				fixedWord = suggestion.charAt(0).toUpperCase() + suggestion.slice(1);
			}
			if(word === word.toUpperCase()) {
				fixedWord = suggestion.toUpperCase();
			}
			currentIssues.push({
				type: 'spelling',
				index: match.index,
				length: word.length,
				original: word,
				suggestion: fixedWord,
				message: `"${word}" → "${fixedWord}"`,
				explain: `Possible misspelling. Did you mean "${fixedWord}"?`
			});
		}
	}
}

function runRuleSet(rules, text) {
	for(const rule of rules) {
		if(rule.skip) continue;
		const regex = new RegExp(rule.regex.source, rule.regex.flags);
		let match;
		while((match = regex.exec(text)) !== null) {
			// Check exceptions
			if(rule.exceptions) {
				const word = match[1] ? match[1].toLowerCase() : '';
				if(rule.exceptions.includes(word)) continue;
			}

			const original = match[0];
			let message = typeof rule.msg === 'function' ? rule.msg(match) : rule.msg;
			if(!message) continue;

			let suggestion = null;
			if(rule.fix) {
				try { suggestion = rule.fix(match, match[1]); } catch(e){}
			}

			currentIssues.push({
				type: rule.type,
				index: match.index,
				length: original.length,
				original: original,
				suggestion: suggestion,
				message: message,
				explain: rule.explain || ''
			});
		}
	}
}

function deduplicateIssues() {
	const seen = new Set();
	currentIssues = currentIssues.filter(issue => {
		const key = issue.index + ':' + issue.length + ':' + issue.type;
		if(seen.has(key)) return false;
		seen.add(key);
		return true;
	});
}

// ─── SCORING ─────────────────────────────────────────────────
function updateScore(text) {
	const words = getWords(text);
	const totalErrors = currentIssues.length;
	const errorRatio = totalErrors / Math.max(words.length, 1);

	// Score: 100 - penalty based on error density
	let score = Math.max(0, Math.min(100, Math.round(100 - (errorRatio * 250))));

	// Color by score
	let color;
	let grade;
	if(score >= 90) { color = 'var(--success)'; grade = 'Excellent — minimal issues'; }
	else if(score >= 75) { color = '#22c55e'; grade = 'Good — a few improvements suggested'; }
	else if(score >= 60) { color = 'var(--warning)'; grade = 'Fair — several issues found'; }
	else if(score >= 40) { color = '#f97316'; grade = 'Needs work — many issues detected'; }
	else { color = 'var(--error)'; grade = 'Poor — significant revision recommended'; }

	// Animate score circle
	const circumference = 188.5;
	const offset = circumference - (score / 100) * circumference;
	scoreFillEl.style.strokeDashoffset = offset;
	scoreFillEl.style.stroke = color;
	scoreValueEl.textContent = score;
	scoreValueEl.style.color = color;
	scoreGradeEl.textContent = grade;

	// Stats
	const counts = {spelling:0, grammar:0, punctuation:0, style:0};
	currentIssues.forEach(i => counts[i.type]++);
	document.getElementById('statTotal').textContent = totalErrors;
	document.getElementById('statSpelling').textContent = counts.spelling;
	document.getElementById('statGrammar').textContent = counts.grammar;
	document.getElementById('statPunctuation').textContent = counts.punctuation;
	document.getElementById('statStyle').textContent = counts.style;
}

// ─── RENDER ISSUES LIST ──────────────────────────────────────
function renderIssues() {
	const filtered = activeFilter === 'all'
		? currentIssues
		: currentIssues.filter(i=>i.type === activeFilter);

	issuesCountEl.textContent = currentIssues.length;

	if(filtered.length === 0) {
		if(currentIssues.length === 0) {
			issuesListEl.innerHTML = '<div class="no-issues"><i class="fas fa-check-circle"></i>Your text looks great!<br>No issues detected.</div>';
		} else {
			issuesListEl.innerHTML = '<div class="no-issues"><i class="fas fa-filter"></i>No issues in this category.</div>';
		}
		return;
	}

	issuesListEl.innerHTML = filtered.map((issue, idx) => {
		const globalIdx = currentIssues.indexOf(issue);
		return `<div class="issue-card ${issue.type}" data-idx="${globalIdx}" onclick="scrollToIssue(${globalIdx})">
			<div class="issue-top">
				<span class="issue-badge ${issue.type}">${issue.type}</span>
				<span class="issue-original">${escHtml(issue.original)}</span>
				${issue.suggestion ? `<span class="issue-arrow"><i class="fas fa-arrow-right"></i></span>
				<span class="issue-suggestion">${escHtml(issue.suggestion)}</span>` : ''}
			</div>
			<div class="issue-explain">${escHtml(issue.message)}${issue.explain ? ' — '+escHtml(issue.explain) : ''}</div>
			${issue.suggestion ? `<button class="issue-fix-btn" onclick="event.stopPropagation();fixIssue(${globalIdx})" title="Apply fix"><i class="fas fa-check"></i></button>` : ''}
		</div>`;
	}).join('');
}

function filterIssues(type, btn) {
	activeFilter = type;
	document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
	btn.classList.add('active');
	renderIssues();
}

function escHtml(str) {
	const d = document.createElement('div');
	d.textContent = str;
	return d.innerHTML;
}

// ─── HIGHLIGHT ERRORS IN EDITOR ──────────────────────────────
function highlightErrors(text) {
	if(currentIssues.length === 0) {
		// Re-set plain text to clear any old highlights
		editorEl.textContent = text;
		return;
	}

	// Sort by index descending to build HTML from back to front
	const sorted = [...currentIssues].sort((a,b)=>b.index - a.index);

	let html = text;
	// We must convert to array for safe splice-like operations with multi-byte safety
	// Use a simple approach: build from sorted issues
	const parts = [];
	let lastIdx = html.length;

	for(const issue of sorted) {
		const start = issue.index;
		const end = start + issue.length;
		if(end > lastIdx) continue; // overlapping, skip
		parts.unshift({
			before: html.substring(end, lastIdx),
			marked: html.substring(start, end),
			type: issue.type,
			idx: currentIssues.indexOf(issue)
		});
		lastIdx = start;
	}

	// Build final HTML
	let result = escHtmlText(html.substring(0, lastIdx));
	for(const p of parts) {
		result += `<span class="err-underline ${p.type}" data-idx="${p.idx}" title="Click to see issue">${escHtmlText(p.marked)}</span>`;
		result += escHtmlText(p.before);
	}

	editorEl.innerHTML = result;

	// Add click handlers to underlined errors
	editorEl.querySelectorAll('.err-underline').forEach(el => {
		el.addEventListener('click', (e) => {
			e.stopPropagation();
			const idx = parseInt(el.getAttribute('data-idx'));
			scrollToIssueCard(idx);
		});
	});
}

function escHtmlText(str) {
	return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

// ─── SCROLL TO ISSUE ─────────────────────────────────────────
function scrollToIssue(idx) {
	const el = editorEl.querySelector(`.err-underline[data-idx="${idx}"]`);
	if(el) {
		el.scrollIntoView({behavior:'smooth', block:'center'});
		el.style.transition='background .2s';
		el.style.background = 'rgba(124,58,237,.25)';
		setTimeout(()=>{ el.style.background = ''; }, 1200);
	}
}

function scrollToIssueCard(idx) {
	const card = issuesListEl.querySelector(`.issue-card[data-idx="${idx}"]`);
	if(card) {
		card.scrollIntoView({behavior:'smooth', block:'center'});
		card.style.transition='box-shadow .2s';
		card.style.boxShadow = '0 0 0 2px var(--primary)';
		setTimeout(()=>{ card.style.boxShadow = ''; }, 1500);
	}
}

// ─── FIX SINGLE ISSUE ────────────────────────────────────────
function fixIssue(idx) {
	const issue = currentIssues[idx];
	if(!issue || !issue.suggestion) return;

	let text = getPlainText();
	// Apply fix at the exact position
	const before = text.substring(0, issue.index);
	const after = text.substring(issue.index + issue.length);
	text = before + issue.suggestion + after;

	// Adjust indices of subsequent issues
	const lengthDiff = issue.suggestion.length - issue.length;
	currentIssues.forEach((other, i) => {
		if(i !== idx && other.index > issue.index) {
			other.index += lengthDiff;
		}
	});

	// Remove this issue
	currentIssues.splice(idx, 1);

	// Re-render
	highlightErrors(text);
	updateScore(text);
	renderIssues();

	if(currentIssues.length === 0) fixAllBtn.style.display = 'none';

	showToast('Fix applied');
}

// ─── FIX ALL ─────────────────────────────────────────────────
function fixAll() {
	const fixable = currentIssues.filter(i=>i.suggestion);
	if(fixable.length === 0){
		showToast('No auto-fixable issues.');
		return;
	}

	let text = getPlainText();

	// Sort fixable by index descending to not mess up offsets
	const sorted = [...fixable].sort((a,b)=>b.index - a.index);
	for(const issue of sorted) {
		const before = text.substring(0, issue.index);
		const after = text.substring(issue.index + issue.length);
		text = before + issue.suggestion + after;
	}

	// Remove all fixed issues
	const fixableSet = new Set(fixable);
	currentIssues = currentIssues.filter(i=>!fixableSet.has(i));

	highlightErrors(text);
	updateScore(text);
	renderIssues();

	if(currentIssues.length === 0) fixAllBtn.style.display = 'none';

	showToast(sorted.length + ' fix'+(sorted.length!==1?'es':'')+' applied!');
}

// ─── COPY TEXT ────────────────────────────────────────────────
function copyText() {
	const text = getPlainText();
	if(!text){showToast('Nothing to copy');return;}
	navigator.clipboard.writeText(text).then(()=>showToast('Text copied to clipboard!'));
}

// ─── CLEAR ALL ────────────────────────────────────────────────
function clearAll() {
	editorEl.innerHTML = '';
	currentIssues = [];
	scorePanelEl.style.display = 'none';
	fixAllBtn.style.display = 'none';
	loadingEl.classList.remove('active');
	issuesListEl.innerHTML = '<div class="no-issues"><i class="fas fa-check-circle"></i>No issues found yet.<br>Click "Check Grammar" to analyze your text.</div>';
	issuesCountEl.textContent = '0';
	wordCountEl.textContent = '0 words';
	sentCountEl.textContent = '0 sentences';
	showToast('Cleared');
}

// ─── Init word/sentence count ─────────────────────────────────
editorEl.dispatchEvent(new Event('input'));
</script>
</body>
</html>
